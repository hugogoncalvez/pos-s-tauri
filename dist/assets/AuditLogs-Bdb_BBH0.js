import{d as g,j as e,T as n,U as b,C as oe,B as p,a as ce,b as de,r as h,e as le,P as ue,G as a,l as w,a0 as B,h as V,i as W,I as S,p as U,R as me,o as pe}from"./index-C4A7YWMW.js";import{S as $}from"./StyledCard-fRo-XxED.js";import{E as he,S as J,a as x}from"./EnhancedTable-BX9li6wm.js";import"./es-CrzwGwgg.js";import{C as O}from"./Chip-Bc7mlkaj.js";import{C as xe}from"./CardContent-BDn6Cs8S.js";import{T as M}from"./Tooltip-DOLZfSzw.js";import{A as H}from"./Autocomplete-okLxTLSl.js";import{C as je}from"./Collapse-Bux-DzTz.js";import"./Card-DZlrFGgg.js";import"./TableRow-BsCYnncP.js";import"./TableBody-Bv-WiDt9.js";import"./Popper-ijWchD3c.js";const _e=g(e.jsx("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess"),Ae=g(e.jsx("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),fe=g(e.jsx("path",{d:"M10 18h4v-2h-4zM3 6v2h18V6zm3 7h12v-2H6z"}),"FilterList"),be=g(e.jsx("path",{d:"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5"}),"Link"),ge=g(e.jsx("path",{d:"M17 7h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.43-.98 2.63-2.31 2.98l1.46 1.46C20.88 15.61 22 13.95 22 12c0-2.76-2.24-5-5-5m-1 4h-2.19l2 2H16zM2 4.27l3.11 3.11C3.29 8.12 2 9.91 2 12c0 2.76 2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1 0-1.59 1.21-2.9 2.76-3.07L8.73 11H8v2h2.73L13 15.27V17h1.73l4.01 4L20 19.74 3.27 3z"}),"LinkOff"),K=({entityType:m,entityId:o})=>{if(!o&&o!==0)return e.jsx(n,{component:"span",variant:"body2",fontWeight:"bold",children:"N/A"});if(m==="customer"&&o===1)return e.jsx(n,{component:"span",variant:"body2",fontWeight:"bold",children:"Consumidor Final"});let l="",d="name";switch(m){case"customer":l=`/customers/${o}`,d="name";break;case"user":l=`/users/${o}`,d="username";break;case"paymentMethod":l=`/payment/${o}`,d="method";break;case"cashSession":return e.jsxs(n,{component:"span",variant:"body2",fontWeight:"bold",children:["#",o]});default:return e.jsx(n,{component:"span",variant:"body2",fontWeight:"bold",children:o})}const{data:s,isLoading:r,isError:c}=b([`entity_${m}`,o],l,!!o);if(r)return e.jsx(oe,{size:14,sx:{verticalAlign:"middle"}});if(c)return e.jsx(O,{label:`Error ID: ${o}`,size:"small",color:"error"});const j=s?s.data?s.data[d]:s[d]:`ID: ${o}`;return e.jsx(n,{component:"span",variant:"body2",fontWeight:"bold",children:j||`ID no encontrado: ${o}`})},Ce={product_name:"Nombre del Producto",quantity:"Cantidad",price:"Precio",description:"Descripción",name:"Nombre",notes:"Notas",status:"Estado",amount:"Monto",total_amount:"Monto Total",total_neto:"Total Neto",promotion_discount:"Descuento por Promoción",customer_id:"Cliente",user_id:"Usuario",payment_method:"Método de Pago",payment_method_id:"Método de Pago",payments:"Pagos",cash_session_id:"Sesión de Caja",sale_id:"Venta",current_stock:"Stock Actual",min_stock:"Stock Mínimo",stock_before:"Stock Anterior",stock_after:"Stock Posterior",quantity_sold:"Cantidad Vendida",original_price:"Precio Original",new_price:"Precio Nuevo",opening_amount:"Monto de Apertura",cashier_declared_amount:"Monto Declarado (Cajero)",admin_verified_amount:"Monto Verificado (Admin)",preliminary_discrepancy:"Diferencia Preliminar",final_discrepancy:"Diferencia Final",declared:"Declarado",verified_amount:"Monto Verificado",discrepancy:"Diferencia",importedCount:"Importados",updatedCount:"Actualizados",errorCount:"Errores",errors:"Detalle de Errores"},ye=({log:m,paymentMethodsMap:o})=>{const l=(s,r)=>{if(s.endsWith("_id")){let c=s.replace("_id","");return s==="payment_method_id"&&(c="paymentMethod"),s==="cash_session_id"&&(c="cashSession"),e.jsx(K,{entityType:c,entityId:r})}return typeof r=="boolean"?e.jsx(O,{label:r?"Sí":"No",size:"small",color:r?"success":"error"}):s==="payments"&&Array.isArray(r)?e.jsx(p,{sx:{pl:2,mt:1},children:r.map((c,j)=>{const _=c.method_id||c.payment_method_id,u=o.has(_)?o.get(_):e.jsx(K,{entityType:"paymentMethod",entityId:_});return e.jsxs(p,{sx:{display:"flex",gap:1},children:[e.jsx(n,{component:"span",variant:"body2",fontWeight:"bold",children:"-"}),e.jsx(n,{component:"span",variant:"body2",fontWeight:"bold",children:u}),e.jsx(n,{component:"span",variant:"body2",fontWeight:"bold",children:":"}),e.jsx(n,{component:"span",variant:"body1",fontWeight:"bold",children:l("amount",c.amount)})]},j)})}):typeof r=="object"&&r!==null?e.jsx("pre",{style:{margin:0,fontFamily:"inherit",fontSize:"inherit"},children:JSON.stringify(r,null,2)}):s.includes("amount")||s.includes("price")||s.includes("total")||s.includes("debt")||s.includes("credit")||s.includes("discrepancy")||s==="promotion_discount"?`$${Number(r).toLocaleString("es-AR",{minimumFractionDigits:2})}`:s.includes("_at")&&r?new Date(r).toLocaleString("es-AR"):String(r)},d=(s,r)=>!r||Object.keys(r).length===0?null:e.jsxs(p,{children:[e.jsx(n,{variant:"subtitle2",gutterBottom:!0,children:s}),Object.entries(r).map(([c,j])=>e.jsxs(p,{sx:{mb:1,display:"flex"},children:[e.jsxs(n,{variant:"body2",sx:{textTransform:"capitalize",minWidth:"180px"},children:[Ce[c]||c.replace(/_/g," "),":"]}),e.jsx(n,{component:"span",variant:"body1",fontWeight:"bold",children:l(c,j)})]},c))]});return e.jsxs(p,{children:[d("Valores Anteriores",m.old_values),m.old_values&&m.new_values&&e.jsx(p,{sx:{my:2}}),d("Valores Nuevos",m.new_values)]})},ze=()=>{var D,k;const m=ce(),o=de(m.breakpoints.down("sm")),[l,d]=h.useState(0),[s,r]=h.useState(5),[c,j]=h.useState(null),_={user_id:"",action:"",entity_type:"",start_date:"",end_date:"",session_id:""},[u,C,G,,v]=le(_),{data:A,refetch:L,isLoading:Z,isFetching:Se}=b(["auditLogs",l,s,u],`/audit/logs?page=${l+1}&limit=${s}&${new URLSearchParams(u)}`,!0,0,{keepPreviousData:!0}),{data:T}=b("auditStats","/audit/stats",!0),{data:I}=b("users","/users",!0),{data:E}=b("paymentMethods","/payment",!0),Y=h.useMemo(()=>I?I.reduce((t,i)=>(t[i.id]=i.username,t),{}):{},[I]),q=h.useMemo(()=>E?new Map(E.map(t=>[t.id,t.method])):new Map,[E]),Q=(A==null?void 0:A.logs)||[],X=((D=A==null?void 0:A.pagination)==null?void 0:D.total)||0;h.useEffect(()=>{L()},[l,s,u,L]);const ee={CREAR_VENTA:"success",ABRIR_SESION_CAJA:"primary",FINALIZAR_CIERRE_CAJA:"secondary",ACTUALIZAR_STOCK:"warning",ELIMINAR:"error",LOGIN:"info",CAMBIO_PRECIO_MANUAL:"warning",ALERTA_STOCK_BAJO:"error"},R={sale:"Venta",cash_session:"Sesión de Caja",stock:"Stock",user:"Usuario",purchase:"Compra",system:"Sistema",sale_item:"Ítem de Venta"},y={CREAR_VENTA:"Crear Venta",ABRIR_SESION_CAJA:"Abrir Caja",INICIO_CIERRE_CAJA:"Iniciar Cierre de Caja",FINALIZAR_CIERRE_CAJA:"Finalizar Cierre de Caja",CIERRE_DIRECTO_CAJA_ADMIN:"Cierre Directo (Admin)",ACTUALIZAR_STOCK:"Actualizar Stock",ELIMINAR:"Eliminar",LOGIN:"Iniciar Sesión",CIERRE_AUTOMATICO_EXITOSO:"Cierre Automático Exitoso",CIERRE_AUTOMATICO_ERROR:"Error en Cierre Automático",IMPORTAR_STOCK:"Importar Stock",ALERTA_STOCK_BAJO:"Alerta de Stock Bajo",VENTA_FORZADA_STOCK_NEGATIVO:"Venta con Stock Negativo",VENTA_PRODUCTO_MANUAL:"Venta de Producto Manual",CAMBIO_PRECIO_MANUAL:"Cambio de Precio Manual",ALERTA_SESION_PROLONGADA:"Alerta de Sesión Prolongada"},N=h.useMemo(()=>{const t=Object.entries(y).map(([i,f])=>({value:i,label:f}));return[{value:"",label:"Todas"},...t]},[y]),P=h.useMemo(()=>{const t=Object.entries(R).map(([i,f])=>({value:i,label:f}));return[{value:"",label:"Todas"},...t]},[R]),te=()=>{G(_),d(0)},F=t=>{v({..._,session_id:t}),d(0)},ne=()=>{F("")},se=t=>{j(c===t?null:t)},re=t=>pe(t).format("DD/MM/YYYY HH:mm:ss"),ie=[{id:"session",label:"Sesión"},{id:"createdAt",label:"Fecha"},{id:"user",label:"Usuario"},{id:"action",label:"Acción"},{id:"entity",label:"Entidad"},{id:"details",label:"Detalles"},{id:"expand",label:"Ver Más"}],ae=t=>{var i,f,z;return e.jsxs(me.Fragment,{children:[e.jsxs(J,{hover:!0,children:[e.jsx(x,{align:"center",children:t.session_id&&e.jsx(M,{title:`Filtrar por esta sesión: ...${t.session_id.slice(-8)}`,children:e.jsx(S,{size:"small",onClick:()=>{F(t.session_id),console.log({log:t})},children:e.jsx(be,{color:u.session_id===t.session_id?"primary":"inherit"})})})}),e.jsx(x,{align:"center",children:re(t.createdAt)}),e.jsxs(x,{align:"center",children:[((i=t.usuario)==null?void 0:i.username)||"N/A",e.jsx("br",{}),e.jsx(n,{variant:"caption",color:"textSecondary",children:((z=(f=t.usuario)==null?void 0:f.rol)==null?void 0:z.nombre)||"N/A"})]}),e.jsx(x,{align:"center",children:e.jsx(O,{label:y[t.action]||t.action,color:ee[t.action]||"default",size:"small"})}),e.jsxs(x,{align:"center",children:[R[t.entity_type]||t.entity_type,t.entity_id&&e.jsxs(n,{variant:"caption",display:"block",children:["ID: ",t.entity_id]})]}),e.jsx(x,{align:"center",children:e.jsx(n,{variant:"body2",noWrap:!0,sx:{maxWidth:250,margin:"0 auto"},children:t.details||"N/A"})}),e.jsx(x,{align:"center",children:e.jsx(M,{title:"Ver detalles completos",children:e.jsx(S,{size:"small",onClick:()=>se(t.id),children:c===t.id?e.jsx(_e,{}):e.jsx(Ae,{})})})})]}),e.jsx(J,{children:e.jsx(x,{style:{paddingBottom:0,paddingTop:0},colSpan:7,children:e.jsx(je,{in:c===t.id,timeout:"auto",unmountOnExit:!0,children:e.jsxs(p,{sx:{margin:1},children:[e.jsx(n,{variant:"h6",gutterBottom:!0,component:"div",children:"Detalles Completos"}),e.jsxs(a,{container:!0,spacing:2,children:[e.jsx(a,{item:!0,xs:12,children:e.jsx(ye,{log:t,usersMap:Y,paymentMethodsMap:q})}),e.jsxs(a,{item:!0,xs:12,md:8,children:[e.jsx(n,{variant:"subtitle2",gutterBottom:!0,children:"Agente de Usuario:"}),e.jsx(n,{variant:"caption",sx:{wordBreak:"break-all"},children:typeof t.user_agent=="string"?t.user_agent||"N/A":JSON.stringify(t.user_agent)})]}),e.jsxs(a,{item:!0,xs:12,md:4,children:[e.jsx(n,{variant:"subtitle2",gutterBottom:!0,children:"Dirección IP:"}),e.jsx(n,{variant:"caption",sx:{wordBreak:"break-all"},children:t.ip_address||"N/A"})]})]})]})})})})]},t.id)};return e.jsxs(p,{sx:{p:1},children:[e.jsxs(ue,{elevation:3,sx:{p:{xs:2,sm:3},mb:3,mt:2,background:t=>t.palette.background.componentHeaderBackground,color:m.palette.primary.contrastText},children:[e.jsx(n,{variant:o?"h5":"h4",gutterBottom:!0,children:"Logs de Auditoría"}),e.jsx(n,{variant:"body1",sx:{opacity:.9},children:"Aquí puedes ver todas las acciones registradas en el sistema."})]}),e.jsxs(a,{container:!0,spacing:3,sx:{mb:3},children:[e.jsx(a,{item:!0,xs:12,md:4,children:e.jsx($,{sx:{height:"100%"},children:T&&e.jsxs(xe,{children:[e.jsx(n,{variant:"h6",gutterBottom:!0,color:"primary",children:"Acciones Más Frecuentes"}),(k=T.actionStats)==null?void 0:k.slice(0,3).map((t,i)=>e.jsxs(p,{sx:{display:"flex",justifyContent:"flex-start",mb:1},children:[e.jsxs(n,{variant:"body2",sx:{mr:1},children:[typeof t.action=="string"?y[t.action]||t.action:JSON.stringify(t.action)," :"]}),e.jsx(n,{variant:"body2",fontWeight:"bold",children:typeof t.count=="number"?t.count:JSON.stringify(t.count)})]},i))]})})}),e.jsx(a,{item:!0,xs:12,md:8,children:e.jsxs($,{elevation:2,sx:{p:2,height:"100%"},children:[e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(n,{variant:"h6",gutterBottom:!0,component:"div",color:"primary",children:[e.jsx(fe,{sx:{mr:1,verticalAlign:"middle"}}),"Filtros"]}),u.session_id&&e.jsx(M,{title:"Quitar filtro de sesión",children:e.jsxs(w,{sx:{padding:"2px 12px"},variant:"outlined",color:"secondary",startIcon:e.jsx(ge,{}),onClick:ne,children:["Sesión: ...",u.session_id.slice(-8)]})})]}),e.jsxs(a,{container:!0,spacing:2,sx:{justifyContent:"center",padding:2},children:[e.jsx(a,{item:!0,sx:{width:"clamp(250px, 30%, 350px)"},children:e.jsxs(a,{container:!0,direction:"column",spacing:2,children:[e.jsx(a,{item:!0,children:e.jsx(H,{fullWidth:!0,size:"small",options:N,getOptionLabel:t=>t.label,value:N.find(t=>t.value===u.action)||null,onChange:(t,i)=>C({target:{name:"action",value:i?i.value:""}}),renderInput:t=>e.jsx(B,{...t,label:"Acción"})})}),e.jsx(a,{item:!0,children:e.jsx(H,{fullWidth:!0,size:"small",options:P,getOptionLabel:t=>t.label,value:P.find(t=>t.value===u.entity_type)||null,onChange:(t,i)=>C({target:{name:"entity_type",value:i?i.value:""}}),renderInput:t=>e.jsx(B,{...t,label:"Tipo de Entidad"})})})]})}),e.jsx(a,{item:!0,sx:{width:"clamp(250px, 30%, 350px)"},children:e.jsxs(a,{container:!0,direction:"column",spacing:2,children:[e.jsx(a,{item:!0,children:e.jsx(V,{fullWidth:!0,size:"small",label:"Fecha Inicio",type:"date",name:"start_date",value:u.start_date,onChange:C,InputLabelProps:{shrink:!0},InputProps:{startAdornment:e.jsx(W,{position:"start",children:e.jsx(S,{size:"small",onClick:()=>v(t=>({...t,start_date:""})),children:e.jsx(U,{fontSize:"small",color:"error"})})})}})}),e.jsx(a,{item:!0,children:e.jsx(V,{fullWidth:!0,size:"small",label:"Fecha Fin",type:"date",name:"end_date",value:u.end_date,onChange:C,InputLabelProps:{shrink:!0},InputProps:{startAdornment:e.jsx(W,{position:"start",children:e.jsx(S,{size:"small",onClick:()=>v(t=>({...t,end_date:""})),children:e.jsx(U,{fontSize:"small",color:"error"})})})}})})]})}),e.jsx(a,{item:!0,sx:{width:"clamp(150px, 15%, 200px)"},children:e.jsx(a,{container:!0,spacing:2,sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",height:"100%"},children:e.jsx(a,{item:!0,children:e.jsx(w,{sx:{padding:"2px 12px"},variant:"outlined",color:"secondary",onClick:te,children:"Limpiar Filtros"})})})})]})]})})]}),e.jsx(he,{columns:ie,data:Q,loading:Z,count:X,page:l,rowsPerPage:s,onPageChange:(t,i)=>d(i),onRowsPerPageChange:t=>{r(parseInt(t.target.value,10)),d(0)},renderRow:ae})]})};export{ze as default};
