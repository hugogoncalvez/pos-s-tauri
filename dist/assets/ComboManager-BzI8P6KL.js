import{a as xe,b as he,r as c,e as be,u as Ce,U as T,f as ge,y as je,j as e,B as f,I as u,P as K,G as a,T as D,l as S,s as X,S as ve,D as fe,q as _e,g as ye,h as p,i as _,p as k,C as ke,k as Ie,w as Ae}from"./index-C4A7YWMW.js";import{E as Pe}from"./EnhancedTable-BX9li6wm.js";import{u as De}from"./useDelete-DGUJ3i20.js";import{c as Se}from"./ConfirmDelete-Bi1GYp2I.js";import{C as Ee}from"./Chip-Bc7mlkaj.js";import{T as G}from"./Tooltip-DOLZfSzw.js";import{E as qe}from"./Edit-B8GMNmyj.js";import{D as Y,A as Z}from"./Delete-BbxDntt0.js";import{A as Fe}from"./Autorenew-waNVMKCV.js";import{A as O}from"./Autocomplete-okLxTLSl.js";import"./TableRow-BsCYnncP.js";import"./TableBody-Bv-WiDt9.js";import"./Popper-ijWchD3c.js";const Qe=()=>{const x=xe(),V=he(x.breakpoints.down("sm")),[I,L]=c.useState(0),[y,ee]=c.useState(5),[te,M]=c.useState(!1),[h,W]=c.useState(null),[b,l,re,,z]=be(),[$,N]=c.useState(!1),[m,j]=c.useState([]),R=[{value:"true",label:"Activo"},{value:"false",label:"Inactivo"}],{tienePermiso:A}=Ce(),{data:E,isLoading:se,isError:oe,error:q,refetch:U}=T("combos","/combos"),{data:i}=T("products","/stock",!0,0,{keepPreviousData:!0}),{data:we}=T("presentations","/presentations"),ne=ge("addCombo"),ae=je("updateCombo"),ie=De("deleteCombo");c.useEffect(()=>{h&&h.combo_items?j(h.combo_items.map(t=>({stock_id:t.stock_id,quantity:t.quantity,component_presentation_id:t.component_presentation_id}))):j([])},[h]);const le=()=>{j([...m,{stock_id:null,quantity:1,component_presentation_id:null}])},de=t=>{const r=m.filter((s,o)=>o!==t);j(r)},F=(t,r,s)=>{console.log(`Actualizando componente ${t}, campo ${r} con valor`,s);const o=[...m];o[t]={...o[t],[r]:s},j(o)},w=(t=null)=>{W(t);const r={name:(t==null?void 0:t.name)||"",barcode:(t==null?void 0:t.barcode)||"",price:(t==null?void 0:t.price)||"",is_active:t?String(t.is_active):"true",start_date:t!=null&&t.start_date?new Date(t.start_date).toISOString().split("T")[0]:"",end_date:t!=null&&t.end_date?new Date(t.end_date).toISOString().split("T")[0]:""};z(r),M(!0)},P=()=>{M(!1),W(null),j([]),re()},ce=async()=>{N(!0);try{const{data:t}=await Ae.get("/barcodes/generate/combo");t&&t.barcode&&z(r=>({...r,barcode:t.barcode}))}catch(t){console.error("Error al generar el código de barras:",t)}finally{N(!1)}},ue=async t=>{if(t.preventDefault(),m.length===0){alert("Un combo debe tener al menos un componente.");return}if(m.some(o=>!o.stock_id||!o.quantity||o.quantity<1)){alert("Todos los componentes del combo deben tener un producto seleccionado y una cantidad válida.");return}const s={...b,is_active:b.is_active==="true",combo_items:m};try{h?await ae.mutateAsync({url:`/combos/${h.id}`,datos:s}):await ne.mutateAsync({url:"/combos",values:s}),U(),P()}catch(o){console.error("Error submitting combo:",o)}},H=async t=>{if((await Se()).isConfirmed)try{await ie.mutateAsync({url:`/combos/${t}`}),U()}catch(s){console.error("Error deleting combo:",s)}},B=c.useMemo(()=>{if(!Array.isArray(E))return[];const t=s=>{const o=new Date;o.setHours(0,0,0,0);const C=s.end_date?new Date(s.end_date):null,g=s.start_date?new Date(s.start_date):null;return C&&C<o?"Finalizado":g&&g>o?"Programado":s.is_active?"Activo":"Inactivo"},r={Activo:1,Programado:2,Inactivo:3,Finalizado:4};return E.map(s=>({...s,status:t(s)})).sort((s,o)=>{const C=r[s.status],g=r[o.status];return C!==g?C-g:new Date(o.start_date)-new Date(s.start_date)})},[E]),me=c.useMemo(()=>B.slice(I*y,I*y+y),[B,I,y]),pe=c.useMemo(()=>[{id:"name",label:"Nombre",sx:{fontWeight:"bold"}},{id:"status",label:"Estado",valueGetter:({row:t})=>{var o;const s=((o={Activo:{color:x.palette.success.main},Programado:{color:x.palette.info.main},Inactivo:{color:x.palette.warning.dark},Finalizado:{color:x.palette.error.dark}}[t.status])==null?void 0:o.color)||"text.secondary";return e.jsx(Ee,{label:t.status,size:"small",sx:{color:s,borderColor:s,fontWeight:"bold"},variant:"outlined"})}},{id:"barcode",label:"Código de Barras"},{id:"price",label:"Precio",valueGetter:({row:t})=>`${parseFloat(t.price).toFixed(2)}`},{id:"start_date",label:"Fecha Inicio",valueGetter:({row:t})=>new Date(t.start_date).toLocaleDateString()},{id:"end_date",label:"Fecha Fin",valueGetter:({row:t})=>new Date(t.end_date).toLocaleDateString()},{id:"actions",label:"Acciones",valueGetter:({row:t})=>e.jsxs(f,{children:[A("gestionar_combos")&&e.jsx(G,{title:"Editar Combo",children:e.jsx(u,{onClick:()=>w(t),size:"small",color:"primary",children:e.jsx(qe,{})})}),A("gestionar_combos")&&e.jsx(G,{title:"Eliminar Combo",children:e.jsx(f,{component:"span",sx:{display:"inline-block"},children:e.jsx(u,{onClick:()=>H(t.id),size:"small",color:"error",disabled:t.status==="Activo",children:e.jsx(Y,{})})})})]})}],[x,A,w,H]);return e.jsxs(f,{sx:{p:{xs:1,sm:2,md:3}},children:[e.jsx(K,{elevation:3,sx:{p:{xs:2,sm:3},mb:3,background:t=>t.palette.background.componentHeaderBackground,color:x.palette.primary.contrastText},children:e.jsxs(a,{container:!0,justifyContent:"space-between",alignItems:"center",children:[e.jsxs(a,{item:!0,children:[e.jsx(D,{variant:V?"h5":"h4",gutterBottom:!0,children:"Gestión de Combos"}),e.jsx(D,{variant:"body1",sx:{opacity:.9},children:"Crea, edita y gestiona los combos de productos."})]}),e.jsx(a,{item:!0,children:A("gestionar_combos")&&e.jsx(S,{variant:"outlined",startIcon:e.jsx(Z,{}),onClick:()=>w(),children:"Nuevo Combo"})})]})}),e.jsxs(K,{elevation:3,sx:{p:{xs:1,sm:2},mb:3},children:[e.jsx(f,{mb:2,p:1,children:e.jsx(D,{variant:"h5",children:"Listado de Combos"})}),oe&&e.jsxs(X,{severity:"error",sx:{mb:2},children:["Error al cargar combos: ",(q==null?void 0:q.message)||"Error desconocido"]}),e.jsx(Pe,{columns:pe,data:me,loading:se,count:B.length,page:I,rowsPerPage:y,onPageChange:(t,r)=>L(r),onRowsPerPageChange:t=>{ee(parseInt(t.target.value,10)),L(0)}})]}),e.jsxs(ve,{open:te,onClose:P,fullWidth:!0,maxWidth:"md",children:[e.jsxs(fe,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"background.dialog",color:"text.primary"},children:[h?"Editar Combo":"Crear Combo",e.jsx(u,{onClick:P,children:e.jsx(_e,{color:"error"})})]}),e.jsxs(f,{component:"form",onSubmit:ue,children:[e.jsx(ye,{sx:{backgroundColor:"background.dialog"},children:e.jsxs(a,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(p,{fullWidth:!0,required:!0,label:"Nombre del Combo",name:"name",value:b.name||"",onChange:l,autoFocus:!0,InputProps:{startAdornment:e.jsx(_,{position:"start",children:e.jsx(u,{onClick:()=>l({target:{name:"name",value:""}}),children:e.jsx(k,{color:"error"})})})}})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(p,{fullWidth:!0,required:!0,label:"Código de Barras",name:"barcode",value:b.barcode||"",onChange:l,InputProps:{readOnly:!0,startAdornment:e.jsx(_,{position:"start",children:e.jsx(u,{onClick:()=>l({target:{name:"barcode",value:""}}),children:e.jsx(k,{color:"error"})})}),endAdornment:e.jsx(_,{position:"end",children:e.jsx(G,{title:"Generar Código de Barras",children:e.jsx(u,{onClick:ce,disabled:$,children:$?e.jsx(ke,{size:24}):e.jsx(Fe,{})})})})}})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(p,{fullWidth:!0,required:!0,type:"number",label:"Precio del Combo",name:"price",value:b.price||"",onChange:l,InputProps:{startAdornment:e.jsx(_,{position:"start",children:e.jsx(u,{onClick:()=>l({target:{name:"price",value:""}}),children:e.jsx(k,{color:"error"})})})}})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(p,{fullWidth:!0,required:!0,type:"date",label:"Fecha de Inicio",name:"start_date",value:b.start_date||"",onChange:l,InputLabelProps:{shrink:!0},InputProps:{startAdornment:e.jsx(_,{position:"start",children:e.jsx(u,{onClick:()=>l({target:{name:"start_date",value:""}}),children:e.jsx(k,{color:"error"})})})}})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(p,{fullWidth:!0,required:!0,type:"date",label:"Fecha de Fin",name:"end_date",value:b.end_date||"",onChange:l,InputLabelProps:{shrink:!0},InputProps:{startAdornment:e.jsx(_,{position:"start",children:e.jsx(u,{onClick:()=>l({target:{name:"end_date",value:""}}),children:e.jsx(k,{color:"error"})})})}})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(O,{fullWidth:!0,required:!0,options:R,getOptionLabel:t=>t.label,value:R.find(t=>t.value===b.is_active)||null,onChange:(t,r)=>{l({target:{name:"is_active",value:r?r.value:""}})},renderInput:t=>e.jsx(p,{...t,label:"Estado"})})}),e.jsxs(a,{item:!0,xs:12,children:[e.jsx(D,{variant:"h6",sx:{mb:2,mt:2},children:"Componentes del Combo"}),m.length===0&&e.jsx(X,{severity:"info",sx:{mb:2},children:"Agregue al menos un producto o presentación al combo."}),m.map((t,r)=>{var s,o,C,g,Q,J;return e.jsx(f,{sx:{border:`1px solid ${x.palette.divider}`,borderRadius:2,p:2,mb:2},children:e.jsxs(a,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(a,{item:!0,xs:12,sm:5,children:e.jsx(O,{options:(i==null?void 0:i.products)||[],getOptionLabel:n=>`${n.name} - ${n.description}`,value:((s=i==null?void 0:i.products)==null?void 0:s.find(n=>n.id===t.stock_id))||null,onChange:(n,d)=>{const v=[...m];v[r]={...v[r],stock_id:(d==null?void 0:d.id)||null,component_presentation_id:null},j(v)},renderInput:n=>e.jsx(p,{...n,label:`Producto ${r+1}`,required:!0})})}),e.jsx(a,{item:!0,xs:12,sm:4,children:e.jsx(O,{options:t.stock_id?((C=(o=i==null?void 0:i.products)==null?void 0:o.find(n=>n.id===t.stock_id))==null?void 0:C.presentations)||[]:[],getOptionLabel:n=>n.name,value:t.stock_id&&((J=(Q=(g=i==null?void 0:i.products)==null?void 0:g.find(n=>n.id===t.stock_id))==null?void 0:Q.presentations)==null?void 0:J.find(n=>n.id===t.component_presentation_id))||null,onChange:(n,d)=>{F(r,"component_presentation_id",(d==null?void 0:d.id)||null)},disabled:!t.stock_id,renderInput:n=>e.jsx(p,{...n,label:"Presentación (Opcional)"})})}),e.jsx(a,{item:!0,xs:6,sm:2,children:e.jsx(p,{type:"number",label:"Cantidad",value:t.quantity,onChange:n=>{const d=n.target.value;if(d===""||d<1){F(r,"quantity","");return}const v=parseInt(d,10);isNaN(v)||F(r,"quantity",v)},inputProps:{min:1,step:1}})}),e.jsx(a,{item:!0,xs:6,sm:1,children:e.jsx(u,{color:"error",onClick:()=>de(r),children:e.jsx(Y,{})})})]})},r)}),e.jsx(S,{variant:"outlined",startIcon:e.jsx(Z,{}),onClick:le,sx:{mt:1},children:"Agregar Componente"})]})]})}),e.jsxs(Ie,{sx:{p:2,backgroundColor:"background.dialog"},children:[e.jsx(S,{onClick:P,variant:"outlined",color:"secondary",sx:{padding:"2px 12px"},children:"Cancelar"}),e.jsx(S,{type:"submit",variant:"contained",children:h?"Actualizar":"Crear"})]})]})]})]})};export{Qe as default};
