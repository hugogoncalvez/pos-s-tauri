import{a as He,r as s,j as e,a1 as vt,D as $e,T as a,g as Ue,G as je,P as L,B as d,a0 as be,k as qe,a2 as Re,c as bt,u as Ct,f as fe,e as St,A as _t,o as w,U as H,l as I,s as It,q as Le,I as D,i as ge,p as ye,h as ee,S as Dt,w as At,x as z}from"./index-C4A7YWMW.js";import{S as M}from"./StyledCard-fRo-XxED.js";import{S as Ft}from"./StyledAutocomplete-D4kJFy6t.js";import{E as Et}from"./EnhancedTable-BX9li6wm.js";import"./es-CrzwGwgg.js";import{C as Be,a as wt,p as Ne,b as zt,c as kt}from"./printCashSessionReport-CU7uc4PA.js";import{D as R}from"./Divider-DlgemNlS.js";import{G as n}from"./Grid2-BbvPN--I.js";import{P as Pt}from"./Person-CvRHMCEB.js";import{C as te}from"./CardContent-BDn6Cs8S.js";import{A as Tt}from"./Assessment-CwVUkKs7.js";import{H as Mt,V as Ve}from"./Visibility-DHbT0-LS.js";import{C as ve}from"./Chip-Bc7mlkaj.js";import{T as re}from"./Tooltip-DOLZfSzw.js";import{K as Rt}from"./KeyboardArrowDown-BYcTFmFP.js";import{A as Oe}from"./Autocomplete-okLxTLSl.js";import{P as Ge}from"./Print-CaR48mkG.js";import{T as Lt,a as Bt,b as Nt,c as We,d as A}from"./TableRow-BsCYnncP.js";import{T as Vt}from"./TableBody-Bv-WiDt9.js";import"./Card-DZlrFGgg.js";import"./Close-C6Pm4Hrr.js";import"./useThemeProps-D8tK1Axd.js";import"./Popper-ijWchD3c.js";const Ot=({open:F,onClose:v,sessionData:l,handleFinalizeClosure:m})=>{var Y;const $=He(),[y,U]=s.useState(""),[P,B]=s.useState("");s.useEffect(()=>{F&&(U(""),B(""))},[F]);const{expectedCash:N,cashSales:V,totalIncome:q,totalExpense:T}=s.useMemo(()=>{var J;if(!l)return{expectedCash:0,cashSales:0,totalIncome:0,totalExpense:0};const x=((J=l.payment_methods)==null?void 0:J.Efectivo)||0,G=parseFloat(l.opening_amount||0),W=parseFloat(l.totalIncome||0),h=parseFloat(l.totalExpense||0);return{expectedCash:G+x+W-h,cashSales:x,totalIncome:W,totalExpense:h}},[l]),i=s.useMemo(()=>y===""||isNaN(parseFloat(y))?null:parseFloat(y)-N,[y,N]),ae=()=>{m(l.id,y,P)},j=x=>new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(x),O=x=>x===null||x===0?"text.primary":x>0?"success.main":"error.main";return l?e.jsxs(vt,{open:F,onClose:v,PaperProps:{sx:{width:"clamp(700px, 90vw, 1000px)",margin:"auto"}},children:[e.jsxs($e,{sx:{textAlign:"center",bgcolor:"secondary.dark",color:$.palette.primary.contrastText},children:["Revisar y Finalizar Cierre de Caja",e.jsxs(a,{variant:"caption",display:"block",children:["Usuario a revisar: ",(Y=l.usuario)==null?void 0:Y.username]})]}),e.jsx(Ue,{sx:{bgcolor:"background.default",p:{xs:1,sm:2}},children:e.jsxs(je,{container:!0,spacing:3,sx:{mt:1,justifyContent:"center"},children:[e.jsx(je,{item:!0,xs:12,md:6,children:e.jsxs(L,{elevation:3,sx:{p:2,height:"100%",display:"flex",flexDirection:"column"},children:[e.jsx(a,{variant:"h6",gutterBottom:!0,align:"center",children:"Declaración del Cajero"}),e.jsx(R,{sx:{mb:2}}),e.jsxs(d,{sx:{flexGrow:1},children:[e.jsx(k,{label:"Monto Inicial:",value:j(l.opening_amount)}),e.jsx(k,{label:"Ventas en Efectivo (Sistema):",value:j(V)}),e.jsx(k,{label:"Ingresos de Caja:",value:j(q)}),e.jsx(k,{label:"Egresos de Caja:",value:j(T)}),e.jsx(R,{sx:{my:1}}),e.jsx(k,{label:"Monto Esperado (Sistema):",value:j(N),boldValue:!0}),e.jsx(k,{label:"Monto Declarado por Cajero:",value:j(l.cashier_declared_amount),boldValue:!0}),e.jsx(k,{label:"Diferencia Preliminar:",value:j(l.preliminary_discrepancy),color:O(l.preliminary_discrepancy),boldValue:!0})]}),e.jsx(R,{sx:{my:2}}),e.jsx(a,{variant:"body2",sx:{fontStyle:"italic"},children:"Notas del Cajero:"}),e.jsx(a,{variant:"body2",sx:{p:1,border:"1px solid",borderColor:"divider",borderRadius:1,mt:1,flexGrow:1},children:l.notes||"Sin notas."})]})}),e.jsx(je,{item:!0,xs:12,md:6,children:e.jsxs(L,{elevation:3,sx:{p:2,height:"100%",display:"flex",flexDirection:"column"},children:[e.jsx(a,{variant:"h6",gutterBottom:!0,align:"center",children:"Verificación del Administrador"}),e.jsx(R,{sx:{mb:2}}),e.jsxs(d,{sx:{flexGrow:1,display:"flex",flexDirection:"column",gap:2},children:[e.jsx(be,{fullWidth:!0,label:"Monto Verificado en Caja",type:"number",value:y,onChange:x=>U(x.target.value),required:!0,autoFocus:!0}),e.jsxs(L,{elevation:2,sx:{p:2,textAlign:"center"},children:[e.jsx(a,{variant:"body2",children:"Diferencia Final"}),e.jsx(a,{variant:"h6",sx:{color:O(i),fontWeight:"bold"},children:i!==null?j(i):"-"})]}),e.jsx(be,{fullWidth:!0,label:"Notas del Administrador (opcional)",multiline:!0,rows:3,value:P,onChange:x=>B(x.target.value)})]})]})})]})}),e.jsxs(qe,{sx:{p:2,justifyContent:"center",gap:2},children:[e.jsx(Re,{onClick:v,sx:{padding:"2px 12px"},variant:"outlined",children:"Cancelar"}),e.jsx(Re,{onClick:ae,variant:"contained",color:"secondary",disabled:y==="",children:"Confirmar y Cerrar Definitivamente"})]})]}):null},k=({label:F,value:v,color:l="text.primary",boldValue:m=!1})=>e.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1.5},children:[e.jsx(a,{variant:"body1",children:F}),e.jsx(a,{variant:"h6",sx:{color:l,fontWeight:m?"bold":"normal"},children:v})]}),ur=()=>{const F=bt(),v=He(),{tienePermiso:l}=Ct(),[m,$]=s.useState([]),[y,U]=s.useState([]),[P,B]=s.useState(null),[N,V]=s.useState(!1),[q,T]=s.useState(!1),[i,ae]=s.useState(null),[j,O]=s.useState(""),[Y,x]=s.useState({}),G=s.useRef(null),[W,h]=s.useState(!1),[K,J]=s.useState(!1),[se,Q]=s.useState(null),[ne,ie]=s.useState(null),{mutateAsync:Ye,isLoading:Ke}=fe(),{mutateAsync:Je,isLoading:Qe}=fe(),{mutateAsync:Xe,isLoading:Ze}=fe(),[u,C,et]=St({userId:null,status:"",startDate:"",endDate:"",finalDiscrepancy:""}),[Ce,f]=s.useState(0),[Se,tt]=s.useState(5),[rt,at]=s.useState(0),[st,oe]=s.useState(!1),[nt,it]=s.useState(null),[ot,le]=s.useState(!1),{usuario:ce,isLoading:de}=s.useContext(_t),_e=[{value:"",label:"Todos"},{value:"cerrada",label:"Cerrada"},{value:"pendiente_cierre",label:"Pendiente Cierre"},{value:"abierta",label:"Abierta"}];s.useEffect(()=>{w.locale("es")},[]);const{data:S,isLoading:lt,error:Ie}=H(["users"],"/users",!de&&l("ver_usuarios")),{data:X,isLoading:ct,error:De,refetch:ue}=H("cashSessions","/cash-sessions/history?status=abierta,pendiente_cierre"),Ae=new URLSearchParams({page:Ce+1,limit:Se,...u.userId&&{user_id:u.userId},...u.status&&{status:u.status},...u.startDate&&{start_date:u.startDate},...u.endDate&&{end_date:u.endDate},...u.finalDiscrepancy&&{final_discrepancy:u.finalDiscrepancy}}).toString(),{data:Z,isLoading:xe,error:Fe,refetch:me}=H(["sessionHistoryAdmin",Ae],`/cash-sessions/history?${Ae}`,!de),{data:he,isLoading:dt,error:Ee}=H(["sessionDetails",se],`/cash-sessions/${se}/summary`,!!se),{data:pe,isLoading:ut,error:we}=H(["sessionToFinalize",ne],`/cash-sessions/${ne}/summary`,!!ne);s.useEffect(()=>{if(S){const t=S.reduce((r,c)=>(r[c.id]=c.username,r),{});x(t)}},[S]),s.useEffect(()=>{(async()=>{if(X&&X.sessions){const r=X.sessions,c=await Promise.all(r.map(async o=>{var g;if(o.status==="abierta")try{const{data:b}=await At.get(`/cash-sessions/${o.id}/summary`),jt=((g=b.payment_methods)==null?void 0:g.Efectivo)||0,ft=b.totalIncome||0,gt=b.totalExpense||0,yt=parseFloat(o.opening_amount)+jt+ft-gt;return{...o,current_cash:yt}}catch(b){return console.error(`Error fetching summary for session ${o.id}:`,b),{...o,current_cash:parseFloat(o.opening_amount)}}else if(o.status==="pendiente_cierre")return{...o,current_cash:parseFloat(o.cashier_declared_amount||0)};return o}));$(c)}else $([])})()},[X]),s.useEffect(()=>{Z&&(U(Z.sessions||[]),at(Z.pagination.total||0))},[Z]),s.useEffect(()=>{he&&(ae(he),T(!0))},[he]),s.useEffect(()=>{pe&&(it(pe),oe(!0))},[pe]),s.useEffect(()=>{var r,c;const t=Ie||De||Fe||Ee||we;if(t){const o=((c=(r=t.response)==null?void 0:r.data)==null?void 0:c.message)||t.message||"Ocurrió un error inesperado";O(o)}},[Ie,De,Fe,Ee,we]),s.useEffect(()=>{W&&!xe&&G.current&&setTimeout(()=>{const t=G.current.getBoundingClientRect().top+window.scrollY;window.scrollTo({top:t,behavior:"smooth"}),h(!1)},100)},[xe,W]);const xt=async(t,r,c)=>{var o,g;if(!P)return z.fire("Error","No hay una sesión seleccionada.","error");try{await Je({url:`/cash-sessions/${P.id}/initiate-close`,values:{cashier_declared_amount:parseFloat(t),notes:r.trim()}}),await z.fire({icon:"info",title:"Cierre Iniciado",text:"La caja ha sido enviada para revisión.",timer:1500,timerProgressBar:!0,showConfirmButton:!1}),V(!1),B(null),ue(),me(),c&&c()}catch(b){z.fire("Error",((g=(o=b.response)==null?void 0:o.data)==null?void 0:g.message)||"Error al iniciar el cierre.","error")}},mt=async(t,r,c)=>{var o,g;try{await Xe({url:`/cash-sessions/${t}/finalize-close`,values:{admin_verified_amount:parseFloat(r),admin_notes:c.trim()}}),z.fire({icon:"success",title:"Caja Cerrada y Verificada",text:"La sesión ha sido cerrada definitivamente.",timer:2e3,timerProgressBar:!0,showConfirmButton:!1}),oe(!1),ie(null),ue(),me()}catch(b){z.fire("Error",((g=(o=b.response)==null?void 0:o.data)==null?void 0:g.message)||"Error al finalizar el cierre.","error")}},ht=async t=>{var r,c;try{await Ye({url:"/cash-sessions/movement",values:t}),z.fire({icon:"success",title:"Movimiento Registrado",text:"El movimiento se ha registrado correctamente.",timer:1500,timerProgressBar:!0,showConfirmButton:!1}),le(!1),ue(),me()}catch(o){z.fire("Error",((c=(r=o.response)==null?void 0:r.data)==null?void 0:c.message)||"Error al registrar el movimiento.","error")}},pt=t=>{B(t),V(!0)},ze=t=>Q(t.id),ke=t=>ie(t.id),p=t=>new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(t||0),_=t=>w(t).format("DD/MM/YYYY HH:mm"),Pe=(t,r=null)=>{const c=w(t),g=(r?w(r):w()).diff(c,"hours",!0);return g>0?g.toFixed(1):"0.0"},Te=t=>{const r=parseFloat(t);return isNaN(r)||r===0?"text.secondary":r>0?"success.main":"error.main"},E=t=>{var c;const r=t==null?void 0:t.usuario;return r!=null&&r.username&&((c=r==null?void 0:r.rol)!=null&&c.nombre)?`${r.username} (${r.rol.nombre})`:Y[t.user_id]||`Usuario ${t.user_id}`},Me=de||lt||ct||xe;return Me?e.jsx(d,{sx:{p:3,textAlign:"center"},children:e.jsx(a,{children:"Cargando..."})}):e.jsxs(d,{sx:{p:1},children:[e.jsx(L,{elevation:3,sx:{p:{xs:2,sm:3},mb:3,mt:2,background:t=>t.palette.background.componentHeaderBackground,color:v.palette.primary.contrastText},children:e.jsxs(n,{container:!0,justifyContent:"space-between",alignItems:"center",children:[e.jsxs(n,{children:[e.jsx(a,{variant:"h4",gutterBottom:!0,children:"Administración de Cajas"}),e.jsx(a,{variant:"body1",sx:{opacity:.9},children:"Vista completa de todas las sesiones de caja"})]}),e.jsxs(n,{children:[e.jsx(I,{variant:"outlined",color:"primary",onClick:()=>le(!0),size:"small",startIcon:e.jsx(Be,{}),sx:{mr:1,padding:"2px 12px"},disabled:m.length===0,children:"Registrar Movimiento"}),e.jsx(I,{variant:"outlined",color:"primary",onClick:()=>F("/mi-caja"),size:"small",startIcon:e.jsx(Pt,{}),sx:{padding:"2px 12px"},children:"Mi Caja"})]})]})}),j&&e.jsx(It,{severity:"error",sx:{mb:2},onClose:()=>O(""),children:j}),e.jsxs(n,{container:!0,spacing:3,sx:{mb:4},justifyContent:"center",children:[e.jsx(n,{xs:12,sm:4,children:e.jsx(M,{children:e.jsxs(te,{children:[e.jsxs(d,{display:"flex",alignItems:"center",mb:1,children:[e.jsx(Be,{color:"primary",sx:{mr:1.5,fontSize:"clamp(1.5rem, 3vw, 2.5rem)"}}),e.jsx(a,{variant:"h6",color:"text.secondary",children:"Sesiones Activas"})]}),e.jsx(a,{variant:"h4",color:"primary.main",fontWeight:"bold",children:m.length})]})})}),e.jsx(n,{xs:12,sm:4,children:e.jsx(M,{children:e.jsxs(te,{children:[e.jsxs(d,{display:"flex",alignItems:"center",mb:1,children:[e.jsx(Tt,{color:"success",sx:{mr:1.5,fontSize:"clamp(1.5rem, 3vw, 2.5rem)"}}),e.jsx(a,{variant:"h6",color:"text.secondary",children:"Monto en Cajas"})]}),e.jsx(a,{variant:"h4",color:"success.main",fontWeight:"bold",children:p(m.reduce((t,r)=>r.status==="abierta"?t+parseFloat(r.current_cash||r.opening_amount||0):r.status==="pendiente_cierre"?t+parseFloat(r.cashier_declared_amount||0):t,0))})]})})}),e.jsx(n,{xs:12,sm:4,children:e.jsx(M,{children:e.jsxs(te,{children:[e.jsxs(d,{display:"flex",alignItems:"center",mb:1,children:[e.jsx(Mt,{color:"info",sx:{mr:1.5,fontSize:"clamp(1.5rem, 3vw, 2.5rem)"}}),e.jsx(a,{variant:"h6",color:"text.secondary",children:"Sesiones Hoy"})]}),e.jsx(a,{variant:"h4",color:"info.main",fontWeight:"bold",children:y.filter(t=>w(t.opened_at).isSame(w(),"day")).length})]})})})]}),e.jsxs(L,{sx:{p:2,mb:3},children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Sesiones de Caja Activas"}),m.length===0?e.jsx(a,{color:"textSecondary",sx:{p:2,textAlign:"center"},children:"No hay sesiones de caja activas"}):e.jsx(n,{container:!0,spacing:1,justifyContent:"center",children:m.map(t=>e.jsx(n,{xs:6,sm:6,md:4,lg:3,children:e.jsxs(M,{variant:"outlined",children:[e.jsxs(te,{sx:{p:2},children:[e.jsxs(d,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1.5,children:[e.jsx(a,{variant:"h6",color:v.palette.text.titlePrimary,children:E(t)}),e.jsx(ve,{label:t.status.replace("_"," "),color:t.status==="abierta"?"success":"warning",size:"small",sx:{textTransform:"capitalize"}})]}),e.jsxs(a,{variant:"body2",color:"textSecondary",children:["Apertura: ",_(t.opened_at)]}),e.jsxs(a,{variant:"body2",color:"textSecondary",children:["Duración: ",Pe(t.opened_at)," horas"]}),e.jsxs(a,{variant:"body1",sx:{mt:1.5,fontWeight:"bold"},children:["Monto inicial: ",p(t.opening_amount)]})]}),e.jsxs(wt,{sx:{p:1.5,justifyContent:"flex-end"},children:[t.status==="abierta"&&(l("ver_cajas_admin")||t.user_id===(ce==null?void 0:ce.id))&&e.jsx(I,{size:"small",color:"error",onClick:()=>pt(t),startIcon:e.jsx(Le,{}),sx:{padding:"2px 12px"},children:"Cerrar Caja"}),t.status==="pendiente_cierre"&&l("ver_cajas_admin")&&e.jsx(I,{size:"small",variant:"contained",color:"secondary",onClick:()=>ke(t),children:"Revisar y Cerrar"}),e.jsx(re,{title:"Ver detalles",children:e.jsx(D,{size:"small",onClick:()=>ze(t),children:e.jsx(Ve,{})})})]})]})},t.id))})]}),e.jsxs(M,{sx:{p:2,mb:3},children:[e.jsxs(n,{container:!0,justifyContent:"space-between",alignItems:"center",sx:{mb:1},children:[e.jsx(a,{variant:"h6",children:"Filtros de Historial"}),e.jsx(D,{disableRipple:!0,size:"small",onClick:()=>J(!K),sx:{p:0},children:e.jsx(Rt,{sx:{transition:"0.5s",transform:K?"rotate(-180deg)":"rotate(0)",backgroundColor:"primary.main",color:"primary.contrastText",borderRadius:"50%"}})})]}),e.jsx(d,{sx:{height:K?"auto":0,overflow:"hidden",transition:"height 0.3s ease-in-out"},children:e.jsxs(n,{container:!0,spacing:2,justifyContent:"center",alignItems:"center",children:[e.jsx(n,{sx:{width:"clamp(280px, 30%, 350px)",padding:2},children:e.jsxs(n,{container:!0,direction:"column",spacing:2,children:[e.jsx(n,{children:e.jsx(Ft,{options:Array.isArray(S)?S:[],getOptionLabel:t=>t.username||"",isOptionEqualToValue:(t,r)=>t.id===r.id,onChange:(t,r)=>{C({target:{name:"userId",value:r?r.id:null}}),f(0),h(!0)},value:(S==null?void 0:S.find(t=>t.id===u.userId))||null,renderInput:t=>e.jsx(be,{...t,label:"Usuario",fullWidth:!0,InputLabelProps:{shrink:!0},InputProps:{...t.InputProps,startAdornment:e.jsx(ge,{position:"start",children:e.jsx(D,{size:"small",onClick:()=>{C({target:{name:"userId",value:null}}),f(0),h(!0)},children:e.jsx(ye,{fontSize:"small",color:"error"})})})}})})}),e.jsx(n,{children:e.jsx(Oe,{options:_e,getOptionLabel:t=>t.label,value:_e.find(t=>t.value===u.status)||null,onChange:(t,r)=>{C({target:{name:"status",value:r?r.value:""}}),f(0),h(!0)},isOptionEqualToValue:(t,r)=>t.value===r.value,renderInput:t=>e.jsx(ee,{...t,label:"Estado",fullWidth:!0})})}),e.jsx(n,{children:e.jsx(Oe,{options:[{value:"",label:"Todos"},{value:"positiva",label:"Positiva"},{value:"negativa",label:"Negativa"},{value:"nula",label:"Nula (0.00)"}],getOptionLabel:t=>t.label,value:[{value:"",label:"Todos"},{value:"positiva",label:"Positiva"},{value:"negativa",label:"Negativa"},{value:"nula",label:"Nula (0.00)"}].find(t=>t.value===u.finalDiscrepancy)||null,onChange:(t,r)=>{C({target:{name:"finalDiscrepancy",value:r?r.value:""}}),f(0),h(!0)},isOptionEqualToValue:(t,r)=>t.value===r.value,renderInput:t=>e.jsx(ee,{...t,label:"Diferencia Final",fullWidth:!0})})})]})}),e.jsx(n,{sx:{width:"clamp(280px, 30%, 350px)"},children:e.jsxs(n,{container:!0,direction:"column",spacing:2,children:[e.jsx(n,{children:e.jsx(ee,{label:"Fecha Desde",type:"date",name:"startDate",value:u.startDate||"",onChange:t=>{C(t),f(0),h(!0)},InputLabelProps:{shrink:!0},InputProps:{startAdornment:e.jsx(ge,{position:"start",children:e.jsx(D,{size:"small",onClick:()=>{C({target:{name:"startDate",value:""}}),f(0),h(!0)},children:e.jsx(ye,{fontSize:"small",color:"error"})})})},fullWidth:!0})}),e.jsx(n,{children:e.jsx(ee,{label:"Fecha Hasta",type:"date",name:"endDate",value:u.endDate||"",onChange:t=>{C(t),f(0),h(!0)},InputLabelProps:{shrink:!0},InputProps:{startAdornment:e.jsx(ge,{position:"start",children:e.jsx(D,{size:"small",onClick:()=>{C({target:{name:"endDate",value:""}}),f(0),h(!0)},children:e.jsx(ye,{fontSize:"small",color:"error"})})})},fullWidth:!0})})]})}),e.jsx(n,{sx:{width:"clamp(180px, 15%, 200px)"},children:e.jsx(n,{container:!0,spacing:2,sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",height:"100%"},children:e.jsx(n,{children:e.jsx(I,{variant:"outlined",color:"secondary",onClick:()=>{et(),f(0),h(!0)},sx:{padding:"2px 12px"},children:"Limpiar"})})})})]})})]}),e.jsxs(M,{sx:{p:2,mb:3},ref:G,children:[e.jsx(a,{variant:"h6",gutterBottom:!0,color:v.palette.text.titlePrimary,children:"Historial Reciente"}),e.jsx(Et,{columns:[{id:"user",label:"Usuario",valueGetter:({row:t})=>E(t)},{id:"opened_at",label:"Apertura",valueGetter:({row:t})=>_(t.opened_at)},{id:"closed_at",label:"Cierre",valueGetter:({row:t})=>t.verified_at?_(t.verified_at):"-"},{id:"opening_amount",label:"Monto Inicial",valueGetter:({row:t})=>p(t.opening_amount)},{id:"total_sales_at_close",label:"Ventas (Cierre)",valueGetter:({row:t})=>p(t.total_sales_at_close||0)},{id:"preliminary_discrepancy",label:"Dif. Preliminar",valueGetter:({row:t})=>p(t.preliminary_discrepancy),cellStyle:t=>({color:Te(t.preliminary_discrepancy)})},{id:"final_discrepancy",label:"Dif. Final",valueGetter:({row:t})=>p(t.final_discrepancy),cellStyle:t=>({color:Te(t.final_discrepancy)})},{id:"status",label:"Estado",valueGetter:({row:t})=>e.jsx(ve,{label:t.status.replace("_"," "),color:t.status==="cerrada"?"default":t.status==="pendiente_cierre"?"warning":"success",size:"small",sx:{textTransform:"capitalize"}})},{id:"actions",label:"Acciones",valueGetter:({row:t})=>e.jsxs(e.Fragment,{children:[e.jsx(re,{title:"Ver Detalles",children:e.jsx(D,{size:"small",onClick:()=>ze(t),children:e.jsx(Ve,{})})}),e.jsx(re,{title:"Imprimir reporte",children:e.jsx(D,{size:"small",onClick:()=>Ne(t,{formatCurrency:p,formatDate:_,getUserName:E}),children:e.jsx(Ge,{})})}),t.status==="pendiente_cierre"&&l("ver_cajas_admin")&&e.jsx(re,{title:"Revisar y Finalizar Cierre",children:e.jsx(I,{size:"small",variant:"contained",color:"secondary",onClick:()=>ke(t),sx:{ml:1},children:"Revisar"})})]})}],data:y,loading:Me,count:rt,page:Ce,rowsPerPage:Se,onPageChange:(t,r)=>f(r),onRowsPerPageChange:t=>{tt(parseInt(t.target.value,10)),f(0)}})]}),e.jsx(zt,{open:N,onClose:()=>V(!1),selectedSession:P,handleInitiateClosure:xt,getUserName:E,isLoading:Qe}),e.jsx(Ot,{open:st,onClose:()=>{oe(!1),ie(null)},sessionData:nt,handleFinalizeClosure:mt,isLoading:ut||Ze}),q&&e.jsxs(Dt,{open:q,onClose:()=>{T(!1),Q(null)},maxWidth:"md",fullWidth:!0,children:[e.jsxs($e,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"background.dialog",color:"text.primary"},children:[e.jsxs(d,{mb:-2,children:["Detalles de Sesión de Caja",i&&e.jsxs(a,{variant:"subtitle2",color:"textSecondary",component:"div",children:["Usuario: ",E(i)]})]}),e.jsx(D,{onClick:()=>{T(!1),Q(null)},children:e.jsx(Le,{color:"error"})})]}),e.jsx(Ue,{sx:{backgroundColor:"background.dialog"},children:dt?e.jsx(a,{sx:{p:3,textAlign:"center"},children:"Cargando detalles..."}):i&&e.jsx(d,{sx:{mt:2},children:e.jsxs(n,{container:!0,spacing:1,children:[e.jsxs(n,{item:!0,xs:12,md:!0,children:[e.jsx(a,{textAlign:"center",variant:"h6",gutterBottom:!0,children:"Información General"}),e.jsxs(d,{mb:1,children:[e.jsx(a,{variant:"body2",color:"textSecondary",children:"Apertura:"}),e.jsx(a,{variant:"body1",children:_(i.opened_at)})]}),e.jsxs(d,{mb:1,children:[e.jsx(a,{variant:"body2",color:"textSecondary",children:"Cierre:"}),e.jsx(a,{variant:"body1",children:i.verified_at?_(i.verified_at):"Sesión Activa"})]}),e.jsxs(d,{mb:1,children:[e.jsx(a,{variant:"body2",color:"textSecondary",children:"Duración:"}),e.jsx(a,{variant:"body1",children:Pe(i.opened_at,i.closed_at)})]})]}),e.jsx(R,{orientation:"vertical",flexItem:!0,sx:{display:{xs:"none",md:"block"}}}),e.jsxs(n,{item:!0,xs:12,md:!0,children:[e.jsx(a,{textAlign:"center",variant:"h6",gutterBottom:!0,children:"Resumen Financiero"}),e.jsxs(d,{ml:2,mb:1,children:[e.jsx(a,{variant:"body2",color:"textSecondary",children:"Monto Apertura:"}),e.jsx(a,{variant:"h6",color:"primary",children:p(i.opening_amount)})]}),e.jsxs(d,{ml:2,mb:1,children:[e.jsx(a,{variant:"body2",color:"textSecondary",children:"Total Ventas:"}),e.jsx(a,{variant:"h6",color:"success.main",children:p(i.total_sales||0)})]}),i.payment_methods&&Object.entries(i.payment_methods).map(([t,r])=>e.jsx(d,{sx:{mb:.5,pl:2},children:e.jsxs(a,{variant:"body2",color:"textSecondary",component:"div",sx:{display:"flex",justifyContent:"space-between"},children:[e.jsxs("span",{children:[t,":"]}),e.jsx("span",{children:p(r)})]})},t)),i.closing_amount&&e.jsxs(d,{mb:1,children:[e.jsx(a,{variant:"body2",color:"textSecondary",children:"Monto Cierre:"}),e.jsx(a,{variant:"h6",color:"info.main",children:p(i.closing_amount)})]})]}),e.jsx(n,{item:!0,xs:12,children:e.jsx(R,{sx:{my:2}})}),e.jsxs(n,{item:!0,xs:12,children:[e.jsx(a,{variant:"h6",gutterBottom:!0,sx:{mt:0},children:"Movimientos de Caja"}),i.movements&&i.movements.length>0?e.jsx(Lt,{component:L,sx:{background:"transparent",border:`1px solid ${v.palette.divider}`},children:e.jsxs(Bt,{size:"small",children:[e.jsx(Nt,{children:e.jsxs(We,{children:[e.jsx(A,{children:"Tipo"}),e.jsx(A,{children:"Monto"}),e.jsx(A,{children:"Descripción"}),e.jsx(A,{children:"Fecha"})]})}),e.jsx(Vt,{children:i.movements.map((t,r)=>e.jsxs(We,{children:[e.jsx(A,{children:e.jsx(ve,{label:t.type==="ingreso"?"Ingreso":"Egreso",color:t.type==="ingreso"?"success":"error",size:"small"})}),e.jsx(A,{children:p(t.amount)}),e.jsx(A,{children:t.description}),e.jsx(A,{children:_(t.createdAt)})]},r))})]})}):e.jsx(a,{variant:"body2",color:"text.secondary",children:"No hay movimientos registrados."})]})]})})}),e.jsxs(qe,{sx:{backgroundColor:"background.dialog"},children:[e.jsx(I,{sx:{padding:"2px 12px"},color:"secondary",variant:"outlined",onClick:()=>{T(!1),Q(null)},children:"Cerrar"}),i&&e.jsx(I,{color:"primary",onClick:()=>Ne(i,{formatCurrency:p,formatDate:_,getUserName:E}),variant:"contained",startIcon:e.jsx(Ge,{}),children:"Imprimir Reporte"})]})]}),e.jsx(kt,{open:ot,onClose:()=>le(!1),onSave:ht,activeSessionId:m.length>0?m[0].id:null,userName:m.length>0?E(m[0]):"",isSaving:Ke})]})};export{ur as default};
