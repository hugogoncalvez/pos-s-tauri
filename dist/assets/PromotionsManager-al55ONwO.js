import{a as ee,b as te,r as d,e as ae,R as se,u as re,U as E,f as ne,y as ie,j as t,B as h,I as c,P as R,G as n,T as k,l as T,s as oe,S as le,D as ce,q as de,g as ue,h as l,i as g,p as j,k as me}from"./index-C4A7YWMW.js";import{E as pe}from"./EnhancedTable-BX9li6wm.js";import{u as xe}from"./useDelete-DGUJ3i20.js";import{c as he}from"./ConfirmDelete-Bi1GYp2I.js";import{T as W}from"./Tooltip-DOLZfSzw.js";import{E as ge}from"./Edit-B8GMNmyj.js";import{D as je,A as ve}from"./Delete-BbxDntt0.js";import{A as y}from"./Autocomplete-okLxTLSl.js";import"./TableRow-BsCYnncP.js";import"./TableBody-Bv-WiDt9.js";import"./Popper-ijWchD3c.js";import"./Chip-Bc7mlkaj.js";const Se=()=>{const o=ee(),M=te(o.breakpoints.down("sm")),[v,S]=d.useState(0),[u,H]=d.useState(5),[z,N]=d.useState(!1),[b,q]=d.useState(null),[s,i,U,,m]=ae();se.useEffect(()=>{s.type==="BOGO"&&m(e=>({...e,discount_value:"0"}))},[s.type,m]);const F=[{value:"BOGO",label:"Paga 1 Lleva 2 (BOGO)"},{value:"PERCENT_DISCOUNT_ON_NTH",label:"Descuento % en N-ésima unidad"},{value:"FIXED_PRICE_ON_NTH",label:"Precio Fijo en N-ésima unidad"}],G=[{value:"true",label:"Activa"},{value:"false",label:"Inactiva"}],{tienePermiso:P}=re(),{data:C,isLoading:V,isError:X,error:f,refetch:B}=E("promotions","/promotions"),{data:I,isLoading:be}=E("products","/stock?limit=1000"),{data:O}=E("presentations","/presentations"),$=ne("addPromotion"),Q=ie("updatePromotion"),J=xe("deletePromotion"),A=(e=null)=>{q(e);const a={name:(e==null?void 0:e.name)||"",type:(e==null?void 0:e.type)||"",discount_value:(e==null?void 0:e.discount_value)||"",required_quantity:(e==null?void 0:e.required_quantity)||"",start_date:e!=null&&e.start_date?new Date(e.start_date).toISOString().split("T")[0]:"",end_date:e!=null&&e.end_date?new Date(e.end_date).toISOString().split("T")[0]:"",is_active:e?String(e.is_active):"true",products:(e==null?void 0:e.products)||[],presentations:(e==null?void 0:e.presentations)||[]};m(a),N(!0)},_=()=>{N(!1),q(null),U()},K=async e=>{e.preventDefault();const a={...s,is_active:s.is_active==="true",products:s.products.map(r=>r.id),presentations:s.presentations.map(r=>r.id)};try{b?await Q.mutateAsync({url:`/promotions/${b.id}`,datos:a}):await $.mutateAsync({url:"/promotions",values:a}),B(),_()}catch(r){console.error("Error submitting promotion:",r)}},L=async e=>{if((await he()).isConfirmed)try{await J.mutateAsync({url:`/promotions/${e}`}),B()}catch(r){console.error("Error deleting promotion:",r)}},D=d.useMemo(()=>{if(!Array.isArray(C))return[];const e=r=>{const p=new Date;p.setHours(0,0,0,0);const x=r.end_date?new Date(r.end_date):null;return x&&x<p?"Finalizada":r.is_active?"Activa":"Inactiva"},a={Activa:1,Inactiva:2,Finalizada:3};return C.map(r=>({...r,status:e(r)})).sort((r,p)=>{const x=a[r.status],w=a[p.status];return x!==w?x-w:new Date(p.start_date)-new Date(r.start_date)})},[C]),Y=d.useMemo(()=>D.slice(v*u,v*u+u),[D,v,u]),Z=d.useMemo(()=>[{id:"name",label:"Nombre",sx:{fontWeight:"bold"}},{id:"status",label:"Estado",valueGetter:({row:e})=>{const r={Activa:{color:o.palette.success.main,bgcolor:o.palette.success.light},Inactiva:{color:o.palette.warning.dark,bgcolor:o.palette.warning.light},Finalizada:{color:o.palette.error.dark,bgcolor:o.palette.error.light}}[e.status]||{color:"text.secondary"};return t.jsx(h,{component:"span",sx:{color:r.color,fontWeight:"bold",py:.5,px:1.5,borderRadius:"12px",display:"inline-block",minWidth:"80px",textAlign:"center",border:`1px solid ${r.color}`},children:e.status})}},{id:"type",label:"Tipo",valueGetter:({row:e})=>({BOGO:"Paga 1 Lleva 2 (BOGO)",PERCENT_DISCOUNT_ON_NTH:"Descuento % en N-ésima unidad",FIXED_PRICE_ON_NTH:"Precio Fijo en N-ésima unidad"})[e.type]||e.type},{id:"discount_value",label:"Valor Descuento"},{id:"required_quantity",label:"Cant. Requerida"},{id:"start_date",label:"Fecha Inicio",valueGetter:({row:e})=>new Date(e.start_date).toLocaleDateString()},{id:"end_date",label:"Fecha Fin",valueGetter:({row:e})=>new Date(e.end_date).toLocaleDateString()},{id:"actions",label:"Acciones",valueGetter:({row:e})=>t.jsxs(h,{children:[P("gestionar_promociones")&&t.jsx(W,{title:"Editar Promoción",children:t.jsx(c,{onClick:()=>A(e),size:"small",color:"primary",children:t.jsx(ge,{})})}),P("gestionar_promociones")&&t.jsx(W,{title:e.status==="Activa"?"No se puede eliminar una promoción activa":"Eliminar Promoción",children:t.jsx("span",{children:t.jsx(c,{onClick:()=>L(e.id),size:"small",color:"error",disabled:e.status==="Activa",children:t.jsx(je,{})})})})]})}],[o,P,A,L]);return t.jsxs(h,{sx:{p:{xs:1,sm:2,md:3}},children:[t.jsx(R,{elevation:3,sx:{p:{xs:2,sm:3},mb:3,background:e=>e.palette.background.componentHeaderBackground,color:o.palette.primary.contrastText},children:t.jsxs(n,{container:!0,justifyContent:"space-between",alignItems:"center",children:[t.jsxs(n,{item:!0,children:[t.jsx(k,{variant:M?"h5":"h4",gutterBottom:!0,children:"Gestión de Promociones"}),t.jsx(k,{variant:"body1",sx:{opacity:.9},children:"Crea, edita y gestiona las promociones y sus asignaciones a productos."})]}),t.jsx(n,{item:!0,children:P("gestionar_promociones")&&t.jsx(T,{variant:"outlined",startIcon:t.jsx(ve,{}),onClick:()=>A(),children:"Nueva Promoción"})})]})}),t.jsxs(R,{elevation:3,sx:{p:{xs:1,sm:2},mb:3},children:[t.jsx(h,{mb:2,p:1,children:t.jsx(k,{variant:"h5",children:"Listado de Promociones"})}),X&&t.jsxs(oe,{severity:"error",sx:{mb:2},children:["Error al cargar promociones: ",(f==null?void 0:f.message)||"Error desconocido"]}),t.jsx(pe,{columns:Z,data:Y,loading:V,count:D.length,page:v,rowsPerPage:u,onPageChange:(e,a)=>S(a),onRowsPerPageChange:e=>{H(parseInt(e.target.value,10)),S(0)}})]}),t.jsxs(le,{open:z,onClose:_,fullWidth:!0,maxWidth:"md",children:[t.jsxs(ce,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"background.dialog",color:"text.primary"},children:[b?"Editar Promoción":"Crear Promoción",t.jsx(c,{onClick:_,children:t.jsx(de,{color:"error"})})]}),t.jsxs(h,{component:"form",onSubmit:K,children:[t.jsx(ue,{sx:{backgroundColor:"background.dialog"},children:t.jsxs(n,{container:!0,spacing:2,sx:{mt:1},children:[t.jsx(n,{item:!0,xs:12,sm:6,children:t.jsx(l,{fullWidth:!0,required:!0,label:"Nombre de la Promoción",name:"name",value:s.name||"",onChange:i,autoFocus:!0,InputProps:{startAdornment:t.jsx(g,{position:"start",children:t.jsx(c,{onClick:()=>i({target:{name:"name",value:""}}),children:t.jsx(j,{color:"error"})})})}})}),t.jsx(n,{item:!0,xs:12,sm:6,children:t.jsx(y,{fullWidth:!0,required:!0,options:F,getOptionLabel:e=>e.label,value:F.find(e=>e.value===s.type)||null,onChange:(e,a)=>{i({target:{name:"type",value:a?a.value:""}})},renderInput:e=>t.jsx(l,{...e,label:"Tipo de Promoción"})})}),t.jsx(n,{item:!0,xs:12,sm:6,children:t.jsx(l,{fullWidth:!0,required:!0,type:"number",label:s.type==="FIXED_PRICE_ON_NTH"?"Precio Fijo":"Valor del Descuento",name:"discount_value",value:s.discount_value||"",onChange:i,disabled:s.type==="BOGO",helperText:s.type==="BOGO"?"No aplicable para promociones BOGO":"",InputProps:{startAdornment:t.jsx(g,{position:"start",children:t.jsx(c,{onClick:()=>i({target:{name:"discount_value",value:""}}),children:t.jsx(j,{color:"error"})})})}})}),t.jsx(n,{item:!0,xs:12,sm:6,children:t.jsx(l,{fullWidth:!0,required:!0,type:"number",label:"Cantidad Requerida",name:"required_quantity",value:s.required_quantity||"",onChange:i,InputProps:{startAdornment:t.jsx(g,{position:"start",children:t.jsx(c,{onClick:()=>i({target:{name:"required_quantity",value:""}}),children:t.jsx(j,{color:"error"})})})}})}),t.jsx(n,{item:!0,xs:12,sm:6,children:t.jsx(l,{fullWidth:!0,required:!0,type:"date",label:"Fecha de Inicio",name:"start_date",value:s.start_date||"",onChange:i,InputLabelProps:{shrink:!0},InputProps:{startAdornment:t.jsx(g,{position:"start",children:t.jsx(c,{onClick:()=>i({target:{name:"start_date",value:""}}),children:t.jsx(j,{color:"error"})})})}})}),t.jsx(n,{item:!0,xs:12,sm:6,children:t.jsx(l,{fullWidth:!0,required:!0,type:"date",label:"Fecha de Fin",name:"end_date",value:s.end_date||"",onChange:i,InputLabelProps:{shrink:!0},InputProps:{startAdornment:t.jsx(g,{position:"start",children:t.jsx(c,{onClick:()=>i({target:{name:"end_date",value:""}}),children:t.jsx(j,{color:"error"})})})}})}),t.jsx(n,{item:!0,xs:12,children:t.jsx(y,{fullWidth:!0,required:!0,options:G,getOptionLabel:e=>e.label,value:G.find(e=>e.value===s.is_active)||null,onChange:(e,a)=>{i({target:{name:"is_active",value:a?a.value:""}})},renderInput:e=>t.jsx(l,{...e,label:"Estado"})})}),t.jsx(n,{item:!0,xs:12,children:t.jsx(y,{multiple:!0,options:(I==null?void 0:I.products)||[],getOptionLabel:e=>e.name,value:s.products||[],onChange:(e,a)=>{m({...s,products:a})},renderInput:e=>t.jsx(l,{...e,label:"Productos Aplicables",placeholder:"Selecciona productos"})})}),t.jsx(n,{item:!0,xs:12,children:t.jsx(y,{multiple:!0,options:(O==null?void 0:O.presentations)||[],getOptionLabel:e=>e.name,value:s.presentations||[],onChange:(e,a)=>{m({...s,presentations:a})},renderInput:e=>t.jsx(l,{...e,label:"Presentaciones Aplicables",placeholder:"Selecciona presentaciones"})})})]})}),t.jsxs(me,{sx:{p:2,backgroundColor:"background.dialog"},children:[t.jsx(T,{onClick:_,variant:"outlined",color:"secondary",sx:{padding:"2px 12px"},children:"Cancelar"}),t.jsx(T,{type:"submit",variant:"contained",children:b?"Actualizar":"Crear"})]})]})]})]})};export{Se as default};
