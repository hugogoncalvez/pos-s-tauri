import{a as $e,b as Ne,r as i,f as ce,e as We,A as Ue,U as Q,o as b,j as e,m as Ye,B as l,P as q,T as a,l as _,a3 as Ke,s as Qe,q as de,I as C,h as E,i as xe,p as me,Z as qe,S as Ze,D as Je,g as Xe,k as es,x as A}from"./index-C4A7YWMW.js";import{S as I}from"./StyledCard-fRo-XxED.js";import"./es-CrzwGwgg.js";import{M as ss}from"./MyFab-Dn2qIpS2.js";import{v as ts}from"./variants-CUQepozP.js";import{C as as,a as ns,b as rs,c as is,p as he}from"./printCashSessionReport-CU7uc4PA.js";import{M as S,E as os}from"./EnhancedTable-BX9li6wm.js";import{G as r}from"./Grid2-BbvPN--I.js";import{C as B}from"./CardContent-BDn6Cs8S.js";import{A as ls}from"./Assessment-CwVUkKs7.js";import{H as cs,V as pe}from"./Visibility-DHbT0-LS.js";import{C as Z}from"./Chip-Bc7mlkaj.js";import{T as J}from"./Tooltip-DOLZfSzw.js";import{K as ds}from"./KeyboardArrowDown-BYcTFmFP.js";import{P as je}from"./Print-CaR48mkG.js";import"./Card-DZlrFGgg.js";import"./Close-C6Pm4Hrr.js";import"./TableRow-BsCYnncP.js";import"./TableBody-Bv-WiDt9.js";import"./Divider-DlgemNlS.js";import"./useThemeProps-D8tK1Axd.js";import"./Popper-ijWchD3c.js";const Fs=()=>{const j=$e(),ue=Ne(j.breakpoints.down("sm")),[h,ge]=i.useState([]),[X,fe]=i.useState([]),[L,ee]=i.useState(null),[ye,H]=i.useState(!1),[ve,T]=i.useState(!1),[be,se]=i.useState(!1),[o,Ce]=i.useState(null),[te,G]=i.useState(""),[Se,ae]=i.useState(!1),[De,O]=i.useState(!1),[V,k]=i.useState(null),[$,_e]=i.useState(!1),{mutateAsync:Ie,isLoading:we}=ce(),{mutateAsync:Me,isLoading:Ae}=ce(),[c,D,Te]=We({status:"",startDate:"",endDate:"",finalDiscrepancy:""}),[N,u]=i.useState(0),[W,ke]=i.useState(5),[Pe,Fe]=i.useState(0),{usuario:t,isLoading:ze}=i.useContext(Ue),{data:P,isLoading:Re,error:f,refetch:U}=Q(["activeSession",t==null?void 0:t.id],`/cash-sessions/active/${t==null?void 0:t.id}`,!!(t!=null&&t.id)),w=new URLSearchParams({page:N+1,limit:W,user_id:t==null?void 0:t.id});c.status&&w.append("status",c.status),c.startDate&&w.append("start_date",c.startDate),c.endDate&&w.append("end_date",c.endDate),c.finalDiscrepancy&&w.append("final_discrepancy",c.finalDiscrepancy);const Ee=`/cash-sessions/history?${w.toString()}`,{data:M,isLoading:Be,error:y,refetch:Y}=Q(["sessionHistory",t==null?void 0:t.id,N,W,c],Ee,!!(t!=null&&t.id)),{data:K,isLoading:Le,error:v}=Q(["sessionDetails",V],`/cash-sessions/${V}/summary`,!!V);i.useEffect(()=>{b.locale("es");const s=()=>{window.scrollY>120?ae(!0):ae(!1)};return window.addEventListener("scroll",s),()=>window.removeEventListener("scroll",s)},[]),i.useEffect(()=>{P&&ge(P.hasActiveSession?[P.session]:[])},[P]),i.useEffect(()=>{M&&(fe(Array.isArray(M.sessions)?M.sessions:[]),Fe(M.pagination.total))},[M]),i.useEffect(()=>{var m,p,z,R,oe,le;const s=((p=(m=f==null?void 0:f.response)==null?void 0:m.data)==null?void 0:p.message)||(f==null?void 0:f.message),n=((R=(z=y==null?void 0:y.response)==null?void 0:z.data)==null?void 0:R.message)||(y==null?void 0:y.message),x=((le=(oe=v==null?void 0:v.response)==null?void 0:oe.data)==null?void 0:le.message)||(v==null?void 0:v.message);G(s||n||x||"")},[f,y,v]),i.useEffect(()=>{K&&(Ce(K),T(!0))},[K]);const He=async(s,n,x)=>{var m,p;if(!L)return A.fire("Error","No hay una sesión seleccionada.","error");try{await Me({url:`/cash-sessions/${L.id}/initiate-close`,values:{cashier_declared_amount:parseFloat(s),notes:n.trim()}}),await A.fire({icon:"info",title:"Cierre Iniciado",text:"Tu caja ha sido enviada para revisión del administrador.",timer:1500,timerProgressBar:!0,showConfirmButton:!1}),H(!1),ee(null),U(),Y(),x&&x()}catch(z){const R=((p=(m=z.response)==null?void 0:m.data)==null?void 0:p.message)||"Error al iniciar el cierre de caja.";A.fire("Error",R,"error")}},Ge=s=>{ee(s),H(!0),G("")},ne=s=>{k(s.id)},d=s=>new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(s||0),g=s=>b(s).format("DD/MM/YYYY HH:mm"),re=(s,n=null)=>{const x=b(s),p=(n?b(n):b()).diff(x,"hours",!0);return p>0?`${p.toFixed(1)} hs`:"0.0 hs"},ie=s=>{const n=parseFloat(s);return isNaN(n)||n===0?{color:"text.secondary"}:{color:n>0?"success.main":"error.main",fontWeight:"bold"}},F=s=>{var x,m;const n=s==null?void 0:s.usuario;return n!=null&&n.username&&((x=n==null?void 0:n.rol)!=null&&x.nombre)?`${n.username} (${n.rol.nombre})`:t!=null&&t.username&&((m=t==null?void 0:t.rol)!=null&&m.nombre)?`${t.username} (${t.rol.nombre})`:(t==null?void 0:t.username)||"Usuario"},Oe=async s=>{var n,x;try{await Ie({url:"/cash-sessions/movement",values:s}),A.fire({icon:"success",title:"Movimiento Registrado",text:"El movimiento de caja ha sido registrado correctamente.",timer:1500,timerProgressBar:!0,showConfirmButton:!1}),O(!1),U(),Y()}catch(m){const p=((x=(n=m.response)==null?void 0:n.data)==null?void 0:x.message)||"Error al registrar el movimiento de caja.";A.fire("Error",p,"error"),console.error("Error al registrar movimiento:",m)}},Ve=[{id:"opened_at",label:"Apertura",valueGetter:({row:s})=>g(s.opened_at)},{id:"verified_at",label:"Cierre",valueGetter:({row:s})=>s.verified_at?g(s.verified_at):"-"},{id:"total_sales_at_close",label:"Ventas (Cierre)",valueGetter:({row:s})=>d(s.total_sales_at_close||0)},{id:"preliminary_discrepancy",label:"Dif. Preliminar",valueGetter:({row:s})=>d(s.preliminary_discrepancy),cellStyle:s=>ie(s.preliminary_discrepancy)},{id:"final_discrepancy",label:"Dif. Final",valueGetter:({row:s})=>d(s.final_discrepancy),cellStyle:s=>ie(s.final_discrepancy)},{id:"status",label:"Estado",valueGetter:({row:s})=>e.jsx(Z,{label:s.status.replace("_"," "),color:s.status==="cerrada"?"default":s.status==="pendiente_cierre"?"warning":"success",size:"small",sx:{textTransform:"capitalize"}})},{id:"actions",label:"Acciones",valueGetter:({row:s})=>e.jsxs(e.Fragment,{children:[e.jsx(J,{title:"Ver Detalles",children:e.jsx(C,{size:"small",onClick:()=>ne(s),children:e.jsx(pe,{})})}),e.jsx(J,{title:"Imprimir reporte",children:e.jsx(C,{size:"small",onClick:()=>he(s,{formatCurrency:d,formatDate:g,getUserName:F}),children:e.jsx(je,{})})})]})}];return e.jsx(Ye.div,{initial:"hidden",animate:"enter",exit:"exit",variants:ts,transition:{duration:.8,type:"easeInOut"},children:e.jsxs(l,{sx:{p:1},children:[e.jsx(ss,{visibleFab:Se,screenSize:{width:window.innerWidth}}),e.jsx(q,{elevation:3,sx:{p:{xs:2,sm:3},mb:3,mt:2,background:s=>s.palette.background.componentHeaderBackground,color:j.palette.primary.contrastText},children:e.jsxs(r,{container:!0,justifyContent:"space-between",alignItems:"center",children:[e.jsxs(r,{children:[e.jsx(a,{variant:ue?"h5":"h4",gutterBottom:!0,children:"Mi Caja"}),e.jsxs(a,{variant:"body1",sx:{opacity:.9},children:["Gestión personal de sesiones de caja - ",t==null?void 0:t.username]})]}),e.jsxs(r,{children:[!h.some(s=>s.status==="abierta")&&e.jsx(_,{variant:"outlined",color:"primary",size:"large",onClick:()=>se(!0),children:"Abrir Caja"}),h.some(s=>s.status==="abierta")&&e.jsx(_,{variant:"outlined",color:"primary",size:"large",onClick:()=>O(!0),startIcon:e.jsx(Ke,{}),sx:{ml:2},children:"Registrar Movimiento"})]})]})}),te&&e.jsx(Qe,{severity:"error",sx:{mb:2},onClose:()=>G(""),children:te}),e.jsxs(r,{container:!0,spacing:3,mb:4,justifyContent:"center",children:[e.jsx(r,{xs:4,children:e.jsx(I,{children:e.jsxs(B,{children:[e.jsxs(l,{display:"flex",alignItems:"center",mb:1,children:[e.jsx(as,{color:"info",sx:{mr:1.5,fontSize:"clamp(1.5rem, 3vw, 4rem)"}}),e.jsx(a,{variant:"h6",color:j.palette.text.titleSecondary,children:"Mi Sesión Activa"})]}),e.jsx(a,{variant:"h5",color:h.length>0?"success.main":"error.main",fontWeight:"bold",children:h.length>0?"ABIERTA":"CERRADA"})]})})}),e.jsx(r,{xs:4,children:e.jsx(I,{children:e.jsxs(B,{children:[e.jsxs(l,{display:"flex",alignItems:"center",mb:1,children:[e.jsx(ls,{color:"info",sx:{mr:1.5,fontSize:"clamp(1.5rem, 3vw, 4rem)"}}),e.jsx(a,{variant:"h6",color:j.palette.text.titleSecondary,children:"Monto en Caja"})]}),e.jsx(a,{variant:"h5",color:"success.main",fontWeight:"bold",children:d(h.reduce((s,n)=>s+parseFloat(n.current_cash||0),0))})]})})}),e.jsx(r,{xs:4,children:e.jsx(I,{children:e.jsxs(B,{children:[e.jsxs(l,{display:"flex",alignItems:"center",mb:1,children:[e.jsx(cs,{color:"info",sx:{mr:1.5,fontSize:"clamp(1.5rem, 3vw, 4rem)"}}),e.jsx(a,{variant:"h6",color:j.palette.text.titleSecondary,children:"Sesiones Hoy"})]}),e.jsx(a,{variant:"h5",color:"info.main",fontWeight:"bold",children:X.filter(s=>b(s.opened_at).isSame(b(),"day")).length})]})})})]}),e.jsxs(q,{sx:{p:2,mb:3},children:[e.jsx(a,{variant:"h6",gutterBottom:!0,color:j.palette.text.titlePrimary,children:"Mi Sesión Activa"}),h.length>0?e.jsx(r,{container:!0,spacing:1,justifyContent:"center",children:h.map(s=>e.jsx(r,{xs:12,sm:8,md:6,children:e.jsxs(I,{variant:"outlined",children:[e.jsxs(B,{sx:{p:2},children:[e.jsxs(l,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1.5,children:[e.jsx(a,{variant:"h6",color:j.palette.text.titlePrimary,children:F(s)}),e.jsx(Z,{label:s.status.replace("_"," "),color:"success",size:"small",sx:{textTransform:"capitalize"}})]}),e.jsxs(a,{variant:"body2",color:"textSecondary",children:["Apertura: ",g(s.opened_at)]}),e.jsxs(a,{variant:"body2",color:"textSecondary",children:["Duración: ",re(s.opened_at)]}),e.jsxs(a,{variant:"body1",sx:{mt:1.5,fontWeight:"bold"},children:["Monto inicial: ",d(s.opening_amount)]})]}),e.jsxs(ns,{sx:{p:1.5,justifyContent:"flex-end"},children:[e.jsx(_,{size:"small",color:"error",onClick:()=>Ge(s),startIcon:e.jsx(de,{}),children:"Cerrar Caja"}),e.jsx(J,{title:"Ver detalles de la sesión actual",children:e.jsx(C,{size:"small",onClick:()=>ne(s),children:e.jsx(pe,{})})})]})]})},s.id))}):e.jsx(a,{color:"textSecondary",sx:{p:2,textAlign:"center"},children:"No tienes ninguna sesión de caja activa."})]}),e.jsxs(I,{sx:{p:2,mb:3},children:[e.jsxs(r,{container:!0,justifyContent:"space-between",alignItems:"center",sx:{mb:1},children:[e.jsx(a,{variant:"h6",children:"Filtros de Historial"}),e.jsx(C,{disableRipple:!0,size:"small",onClick:()=>_e(!$),sx:{p:0},children:e.jsx(ds,{sx:{transition:"0.5s",transform:$?"rotate(-180deg)":"rotate(0)",backgroundColor:"primary.main",color:"primary.contrastText",borderRadius:"50%"}})})]}),e.jsx(l,{sx:{height:$?"auto":0,overflow:"hidden",transition:"height 0.3s ease-in-out"},children:e.jsxs(r,{container:!0,spacing:2,justifyContent:"center",alignItems:"center",children:[e.jsx(r,{sx:{width:"clamp(250px, 30%, 350px)"},children:e.jsxs(r,{container:!0,direction:"column",spacing:2,children:[e.jsx(r,{children:e.jsxs(E,{select:!0,label:"Estado",name:"status",value:c.status||"",onChange:s=>{D(s),u(0)},children:[e.jsx(S,{value:"",children:"Todos"}),e.jsx(S,{value:"cerrada",children:"Cerrada"}),e.jsx(S,{value:"pendiente_cierre",children:"Pendiente Cierre"})]})}),e.jsx(r,{children:e.jsxs(E,{select:!0,label:"Diferencia Final",name:"finalDiscrepancy",value:c.finalDiscrepancy||"",onChange:s=>{D(s),u(0)},children:[e.jsx(S,{value:"",children:"Todos"}),e.jsx(S,{value:"positiva",children:"Positiva"}),e.jsx(S,{value:"negativa",children:"Negativa"}),e.jsx(S,{value:"nula",children:"Nula (0.00)"})]})})]})}),e.jsx(r,{sx:{width:"clamp(250px, 30%, 350px)"},children:e.jsxs(r,{container:!0,direction:"column",spacing:2,children:[e.jsx(r,{children:e.jsx(E,{label:"Fecha Desde",type:"date",name:"startDate",value:c.startDate||"",onChange:s=>{D(s),u(0)},InputLabelProps:{shrink:!0},InputProps:{startAdornment:e.jsx(xe,{position:"start",children:e.jsx(C,{size:"small",onClick:()=>{D({target:{name:"startDate",value:""}}),u(0)},children:e.jsx(me,{fontSize:"small",color:"error"})})})}})}),e.jsx(r,{children:e.jsx(E,{label:"Fecha Hasta",type:"date",name:"endDate",value:c.endDate||"",onChange:s=>{D(s),u(0)},InputLabelProps:{shrink:!0},InputProps:{startAdornment:e.jsx(xe,{position:"start",children:e.jsx(C,{size:"small",onClick:()=>{D({target:{name:"endDate",value:""}}),u(0)},children:e.jsx(me,{fontSize:"small",color:"error"})})})}})})]})}),e.jsx(r,{sx:{width:"clamp(150px, 15%, 200px)"},children:e.jsx(r,{container:!0,spacing:2,sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",height:"100%"},children:e.jsx(r,{children:e.jsx(_,{variant:"outlined",color:"secondary",onClick:()=>{Te(),u(0)},children:"Limpiar"})})})})]})})]}),e.jsxs(I,{sx:{p:2,mb:3},children:[e.jsx(a,{variant:"h6",gutterBottom:!0,color:j.palette.text.titlePrimary,children:"Mi Historial de Sesiones"}),e.jsx(os,{columns:Ve,data:X,loading:ze||Re||Be,count:Pe,page:N,rowsPerPage:W,onPageChange:(s,n)=>u(n),onRowsPerPageChange:s=>{ke(parseInt(s.target.value,10)),u(0)}})]}),e.jsx(qe,{open:be,onClose:()=>{se(!1),U(),Y()},userId:t==null?void 0:t.id,activeSession:h.length>0?h[0]:null}),e.jsx(rs,{open:ye,onClose:()=>H(!1),selectedSession:L,handleInitiateClosure:He,getUserName:F,isLoading:Ae}),e.jsx(is,{open:De,onClose:()=>O(!1),onSave:Oe,activeSessionId:h.length>0?h[0].id:null,isSaving:we}),e.jsxs(Ze,{open:ve,onClose:()=>{T(!1),k(null)},maxWidth:"md",fullWidth:!0,children:[e.jsxs(Je,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"background.dialog",color:"text.primary"},children:["Detalles de Mi Sesión",e.jsx(C,{onClick:()=>{T(!1),k(null)},children:e.jsx(de,{color:"error"})})]}),e.jsx(Xe,{sx:{backgroundColor:"background.dialog",p:3},children:Le?e.jsx(a,{sx:{p:3,textAlign:"center"},children:"Cargando detalles..."}):o&&e.jsx(l,{sx:{mt:2},children:e.jsxs(r,{container:!0,spacing:3,children:[e.jsxs(r,{item:!0,xs:12,md:6,children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Información General"}),e.jsxs(l,{mb:1,children:[e.jsx(a,{variant:"body2",color:"textSecondary",children:"Apertura:"}),e.jsx(a,{variant:"body1",children:g(o.opened_at)})]}),e.jsxs(l,{mb:1,children:[e.jsx(a,{variant:"body2",color:"textSecondary",children:"Cierre:"}),e.jsx(a,{variant:"body1",children:o.verified_at?g(o.verified_at):"Sesión Activa"})]}),e.jsxs(l,{mb:1,children:[e.jsx(a,{variant:"body2",color:"textSecondary",children:"Duración:"}),e.jsx(a,{variant:"body1",children:re(o.opened_at,o.closed_at)})]})]}),e.jsxs(r,{item:!0,xs:12,md:6,children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Resumen Financiero"}),e.jsxs(l,{mb:1,children:[e.jsx(a,{variant:"body2",color:"textSecondary",children:"Monto Apertura:"}),e.jsx(a,{variant:"h6",color:"primary",children:d(o.opening_amount)})]}),e.jsxs(l,{mb:1,children:[e.jsx(a,{variant:"body2",color:"textSecondary",children:"Total Ventas:"}),e.jsx(a,{variant:"h6",color:"success.main",children:d(o.total_sales||0)})]}),o.payment_methods&&Object.entries(o.payment_methods).map(([s,n])=>e.jsx(l,{sx:{mb:.5,pl:2},children:e.jsxs(a,{variant:"body2",color:"textSecondary",component:"div",sx:{display:"flex",justifyContent:"space-between"},children:[e.jsxs("span",{children:[s,":"]}),e.jsx("span",{children:d(n)})]})},s)),o.closing_amount&&e.jsxs(l,{mb:1,children:[e.jsx(a,{variant:"body2",color:"textSecondary",children:"Monto Cierre:"}),e.jsx(a,{variant:"h6",color:"info.main",children:d(o.closing_amount)})]})]}),e.jsxs(r,{item:!0,xs:12,children:[e.jsx(a,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"Movimientos de Caja"}),o.movements&&o.movements.length>0?e.jsx(TableContainer,{component:q,sx:{background:"transparent",border:`1px solid ${j.palette.divider}`},children:e.jsxs(Table,{size:"small",children:[e.jsx(TableHead,{children:e.jsxs(TableRow,{children:[e.jsx(TableCell,{children:"Tipo"}),e.jsx(TableCell,{children:"Monto"}),e.jsx(TableCell,{children:"Descripción"}),e.jsx(TableCell,{children:"Fecha"})]})}),e.jsx(TableBody,{children:o.movements.map((s,n)=>e.jsxs(TableRow,{children:[e.jsx(TableCell,{children:e.jsx(Z,{label:s.type==="ingreso"?"Ingreso":"Egreso",color:s.type==="ingreso"?"success":"error",size:"small"})}),e.jsx(TableCell,{children:d(s.amount)}),e.jsx(TableCell,{children:s.description}),e.jsx(TableCell,{children:g(s.createdAt)})]},n))})]})}):e.jsx(a,{variant:"body2",color:"text.secondary",children:"No hay movimientos registrados para esta sesión."})]})]})})}),e.jsxs(es,{sx:{p:2,backgroundColor:"background.dialog"},children:[e.jsx(_,{sx:{padding:"2px 12px"},variant:"outlined",color:"secondary",onClick:()=>{T(!1),k(null)},children:"Cerrar"}),o&&e.jsx(_,{onClick:()=>he(o,{formatCurrency:d,formatDate:g,getUserName:F}),variant:"contained",startIcon:e.jsx(je,{}),children:"Imprimir"})]})]})]})})};export{Fs as default};
